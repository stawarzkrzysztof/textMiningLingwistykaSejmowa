---
title: "Posłowie - 11.01.2026"
format: 
  html:
    toc: false
    number-sections: true
    code-tools: true
    code-fold: true
    html-table-processing: none
    mainfont: Calibri
    monofont: "Andale Mono"
    include-in-header:
      text: |
        <style>
        body {
          font-family: Calibri, sans-serif;
        }
        code, pre, kbd, samp, .sourceCode, pre code {
          font-family: "Andale Mono", monospace;
        }
        p {
          text-align: justify;
        }
        </style>
execute:
  echo: true
  warning: false
  message: false

---

```{r}
#| code-summary: "Setup"
#| label: setup
library(tidyverse)
library(plotly)
library(gt)
library(tidyverse)
library(scales)
library(ggtext)
library(ggrepel)

df <- read.csv("/Users/krzysztofstawarz/GithubRepositories/textMiningLingwistykaSejmowa/2dataPreprocessing/dataPreprocessed/mp.csv", na.strings = c(""))



df <- df |>
  mutate(
    klub = as.factor(klub),
    dataUr = as.Date(dataUr),
    plec = as.factor(plec),
    wyksztalcenie = if_else(
      wyksztalcenie == "('średnie ogólne',)",
      "średnie ogólne",
      as.character(wyksztalcenie)) |> as.factor(),
    najwyzszyStopienNaukowy = as.factor(najwyzszyStopienNaukowy),
    czyAktywny = as.logical(czyAktywny),
    nrOkreguWyborczego = as.factor(nrOkreguWyborczego)
  )

knitr::opts_chunk$set(
  fig.width  = 8,        
  # fig.asp    = 0.62,     
  dpi        = 320,      
  fig.retina = 2,        
  fig.align  = "center",
  out.width  = "100%"    
)

# okabe_ito <- c(
#   "#E69F00", "#56B4E9", "#009E73", "#F0E442",
#   "#0072B2", "#D55E00", "#CC79A7", "#000000"
# )

# # options(
# #   ggplot2.discrete.colour = okabe_ito,
# #   ggplot2.discrete.fill   = okabe_ito
# # )

theme_set(
  theme_minimal(base_size = 12, base_family = "Calibri") +
    theme(
      plot.title.position   = "plot",
      plot.caption.position = "plot",
      panel.grid.minor      = element_blank(),
      legend.position       = "right"
    )
)

clubs <- read.csv("/Users/krzysztofstawarz/GithubRepositories/textMiningLingwistykaSejmowa/2dataPreprocessing/dataPreprocessed/clubs.csv", na.strings = c(""))
club_palette_core <- c(
  "PiS"             = "#012B7F",
  "KO"              = "#FF7F2A",
  "PSL"             = "#30D397",
  "Polska2050"      = "#FFC302",
  "Lewica"          = "#D62943",
  "Konfederacja"    = "#153560",
  "niez."           = "#7A7A7A",
  "Razem"           = "#870E57",
  "Republikanie"    = "#15233F",
  "Konfederacja_KP" = "#A27819"
)

sex_palette <- c(
  "Kobiety"    = "#C51B7D",
  "Mężczyźni"  = "#2C7FB8"
)

all_ids <- clubs |> dplyr::distinct(id) |> dplyr::pull(id)
club_palette <- stats::setNames(rep("#7A7A7A", length(all_ids)), all_ids)
club_palette[names(club_palette_core)] <- club_palette_core[names(club_palette_core)]
# zapamiętaj oryginalną funkcję z pakietu
gt_base <- gt::gt

# nadpisz gt() w globalnym środowisku (tylko w tym dokumencie/sesji)
gt <- function(..., id = NULL, locale = NULL, groupname_col = NULL, rowname_col = NULL) {
  gt_base(
    ...,
    id = id,
    locale = locale,
    groupname_col = groupname_col,
    rowname_col = rowname_col
  ) |>
    gt::opt_table_font(                               # <-- TU
      font = c("Calibri", "sans-serif")
    ) |>
    cols_align(align = "center", columns = everything()) |>
    tab_options(
      table.width = pct(100),
      table.layout = "fixed",
      table.font.size = px(10),
      data_row.padding = px(5)
    ) |>
    tab_style(
      style = cell_text(whitespace = "normal"),
      locations = cells_body()
    )
}

colorRowsByClub <- function(t, pal = club_palette_core, alpha = 0.35) {

  d <- gt:::dt_data_get(t)   # <-- potrójny dwukropek (wewnętrzne API)

  if (!"klub" %in% names(d)) return(t)

  clubs <- intersect(unique(as.character(d$klub)), names(pal))

  for (clb in clubs) {
    t <- t |>
      gt::tab_style(
        style = list(
          gt::cell_fill(color = scales::alpha(pal[[clb]], alpha)),
          gt::cell_text(color = "black")
        ),
        locations = gt::cells_body(rows = klub == clb)
      )
  }

  t
}

library(ggtext)

mk_labels <- function(pal) {
  setNames(
    sprintf("<span style='color:%s'>%s</span>", pal, names(pal)),
    names(pal)
  )
}

club_labels <- mk_labels(club_palette_core)
sex_labels  <- mk_labels(sex_palette)

spread_y <- function(y, min_gap) {
  if (length(y) <= 1) return(y)
  o <- order(y)
  yy <- y[o]
  for (i in 2:length(yy)) {
    if ((yy[i] - yy[i-1]) < min_gap) yy[i] <- yy[i-1] + min_gap
  }
  y2 <- y
  y2[o] <- yy
  y2
}

make_outside_labels <- function(layout, group_col, delta_frac = 0.24, min_gap_frac = 0.10) {
  g <- rlang::sym(group_col)
  maxr <- max(layout$r, na.rm = TRUE)
  delta <- delta_frac * maxr
  min_gap <- min_gap_frac * maxr

  edge <- layout |>
    group_by(!!g) |>
    slice_max(r, n = 1, with_ties = FALSE) |>
    ungroup() |>
    mutate(
      ux = x / r, uy = y / r,
      x_lab = x + ux * delta,
      y_lab = y + uy * delta
    )

  edge$y_lab <- spread_y(edge$y_lab, min_gap)
  edge
}
```

# Skład i rotacja
Zgodnie z art. 96 ust. 1 Konstytucji Rzeczypospolitej Polskiej z dnia 2 kwietnia 1997 r. (Dz.U. 1997 nr 78 poz. 483)[^konst460] polski Sejm składa się z **460** posłów. Zgodnie z art. 98 ust. 1 Konstytucji Rzeczypospolitej Polskiej z dnia 2 kwietnia 1997 r. (Dz.U. 1997 nr 78 poz. 483)[^konst4lata] sejmowi posłowie wybierani są na **czteroletnie kadencje**. W trakcie tych lat w polityce dzieją się rzeczy różne - poza wyborami parlamentarnymi odbywają się również wybory do europarlamentu czy też wybory prezydenckie. Nierzadko więc posłowie obejmują inne stanowiska i pozycje, lub z innych przyczyn nie mogą wypełnić swojego czteroletniego mandatu. W sytuacjach takich, zgodnie z art. 251 § 1–3 ustawy z dnia 5 stycznia 2011 r. – Kodeks wyborczy[^kodWybMandat], mandat przypada kolejnemu kandydatowi z tej samej listy wyborczej w tym samym okręgu wyborczym, który uzyskał następno najwyższą liczbę głosów w wyborach (o ile nie zachodzą przeszkody prawne do objęcia mandatu lub kandydat nie zrzeknie się pierwszeństwa).  
    
```{r}
#| code-summary: "Liczba aktywnych i nieaktywnych posłów w bazie danych (stan na 11 stycznia 2026)"
#| label: aktywniTable
df |> 
  summarize(
    aktywny = sum(czyAktywny),
    nieaktywny = sum(!czyAktywny),
    suma = n()) |> 
  gt()
```  
  

```{r}
#| code-summary: "Aktywni posłowie X kadencji wg klubów"
#| label: mandatyBarChart
#| fig-height: 4
df |>
  filter(czyAktywny) |>
  count(klub, name = "n") |>
  mutate(klub = forcats::fct_reorder(klub, n, .desc = TRUE)) |> 
  ggplot()+
  aes(x = fct_infreq(klub), y = n, fill = klub) +
  geom_col(width = .5) +
  geom_text(aes(label = n, colour = klub), vjust = -0.4, show.legend = FALSE) +
  geom_text(aes(label = klub, colour = klub), y = -3, vjust = 1, show.legend = FALSE, size=2.5)  +
  scale_fill_manual(values = club_palette_core) +
  scale_colour_manual(values = club_palette_core, guide = "none") +
  scale_y_continuous(limits = c(-1, 200), breaks = seq(0, 200, 20)) +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_line(linetype = "dotted", alpha = .7),
    axis.text.y = element_text(colour = "lightgrey"),
    axis.title = element_blank(),
    axis.text.x = element_blank(),   
    axis.ticks.x = element_blank(),
    legend.position = "none"
  )
```

```{r}
#| code-summary: "Aktywni posłowie X kadencji wg klubów - symulacja sali sejmowej"
#| label: parlimentMandaty

library(shadowtext)
levels_order <- c(
  "PiS","KO","PSL","Polska2050","Lewica",
  "Konfederacja","niez.","Razem","Republikanie","Konfederacja_KP"
)

seats <- df |>
  filter(czyAktywny, !is.na(klub)) |>
  count(klub, name = "seats") |>
  mutate(party = factor(klub, levels = levels_order)) |>
  arrange(party)

layout <- ggparliament::parliament_data(
  election_data = NULL,
  party_seats   = seats$seats,
  type          = "semicircle",
  parl_rows     = 10
)

# promień (żeby w ramach tego samego kąta wypełniać rzędy spójnie)
layout <- layout |>
  mutate(r = sqrt(x^2 + y^2)) |>
  arrange(desc(theta), desc(r))  # LEWA->PRAWA, a w ramach kąta: zewnątrz->środek

layout$party <- rep(as.character(seats$party), seats$seats)
library(ggtext)
library(scales)

mk_labels <- function(pal) {
  setNames(
    sprintf("<span style='color:%s'>%s</span>", pal, names(pal)),
    names(pal)
  )
}
club_labels <- mk_labels(club_palette_core)

total_seats <- 460L

party_stats <- seats |>
  mutate(
    party   = as.character(party),
    pct     = seats / total_seats,
    pct_lab = scales::percent(pct, accuracy = 1)
  ) |>
  select(party, pct_lab)

party_pos <- layout |>
  group_by(party) |>
  summarise(x = mean(x), y = mean(y), .groups = "drop") |>
  # delikatnie "na zewnątrz" żeby nie nachodziło na kropki
  mutate(x = x * 1.05, y = y * 1.05)

party_lab <- party_pos |>
  left_join(party_stats, by = "party")
layout$party <- factor(layout$party, levels = levels_order)

ggplot(layout, aes(x, y, colour = party)) +
  geom_point(size = 5) + 
  shadowtext::geom_shadowtext(
    data = party_lab,
    aes(x = x, y = y, label = pct_lab, colour = party),
    inherit.aes = FALSE,
    fontface = "bold",
    size = 3.5,                       
    bg.colour = scales::alpha("white", 0.95), 
    bg.r = 0.25,
    show.legend = FALSE
  ) +
  coord_equal() +
  scale_colour_manual(values = club_palette_core, limits = levels_order, name = "Klub", labels = club_labels) +
  theme_void() +
  theme(legend.position = "bottom", 
  legend.title = element_blank(),
  legend.text = ggtext::element_markdown())
```

W trakcie trwania X kadencji sejmu – od 13 listopada 2023 r. do dnia pobrania danych z API Sejmu oraz strony Sejmu[^stronaSejmu], tj. do 11 stycznia 2026 r. sytuacji, w których poseł przestał być aktywny i został zastąpiony było **38**. Oznacza to, że w sejmowej bazie danych widnieje **498** posłów – z czego **460** posłów aktywnych i **38** posłów nieaktywnych.

```{r}
#| code-summary: "Nieaktywni posłowie X kadencji wg klubów"
#| label: nieaktywniMPbarChart
#| fig-height: 4
df |>
  filter(!czyAktywny) |>
  count(klub, name = "n") |>
  mutate(klub = forcats::fct_reorder(klub, n, .desc = TRUE)) |> 
  ggplot()+
  aes(x = fct_infreq(klub), y = n, fill = klub) +
  geom_col(width = .5) +
  geom_text(aes(label = n, colour = klub), vjust = -0.4, show.legend = FALSE) +
  geom_text(aes(label = klub, colour = klub), y = -0.6, vjust = 1, show.legend = FALSE) +
  scale_fill_manual(values = club_palette_core) +
  scale_colour_manual(values = club_palette_core, guide = "none") +
  scale_y_continuous(limits = c(-1, 19), breaks = seq(0, 19, 1)) +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_line(linetype = "dotted", alpha = .7),
    axis.text.y = element_text(colour = "lightgrey"),
    axis.title = element_blank(),
    axis.text.x = element_blank(),   
    axis.ticks.x = element_blank(),
    legend.position = "none"
  )
```

```{r}
#| code-summary: "Przyczyny nieaktywności posłów X kadencji wg klubów"
#| label: powodyNieaktywnosciBarChart
#| fig-height: 3
pos <- position_dodge2(width = 1, preserve = "single")

df |>
  mutate(
    nieaktywnoscKategoria = factor(nieaktywnoscKategoria, levels = c(
      "Zgon",
      "Utrata prawa wybieralności",
      "Objęcie funkcji w samorządzie",
      "Objęcie funkcji w administracji centralnej",
      "Mandat w Parlamencie Europejskim")),
    klub = factor(klub, levels = c("PSL","Polska2050","Lewica", "Konfederacja", "PiS","KO"))) |>
  filter(!czyAktywny) |>
  count(nieaktywnoscKategoria, klub, name = "n") |>
  ggplot(aes(y = nieaktywnoscKategoria, x = n, fill = klub)) +
  geom_col(width = 1, position = pos, alpha = 1) +
  geom_text(
    aes(label = paste0(as.character(klub), " (", n, ")"), colour = klub),
    position = pos,
    hjust = -0.1,
    size = 2,
    show.legend = FALSE,
    alpha = 1) +
  scale_x_continuous(breaks = seq(0, 14, by = 1), limits = c(0, 14)) +
  scale_fill_manual(values = club_palette_core) +
  scale_colour_manual(values = club_palette_core, guide = "none") +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_line(linetype = "dotted", alpha = .7),
    axis.title = element_blank(),
    axis.text.x = element_text(colour = "lightgrey"),
    axis.text.y = element_text(colour = "black"),
    legend.position = "none")
```

```{r}
#| code-summary: "Nieaktywni posłowie X kadencji, którzy nie otrzymali mandatu w PE"
#| label: niekatywniPoslowieTable

df |>
  filter(!czyAktywny, nieaktywnoscKategoria != "Mandat w Parlamencie Europejskim") |>
  select(imieNazwisko, klub, nieaktywnoscKategoria, nieaktywnoscKomentarz) |>
  arrange(nieaktywnoscKategoria) |> 
  gt() |> 
  colorRowsByClub()
```

# Demografia Sejmu
## Wiek

```{r}
#| code-summary: "Statystyki deskryptywne wieku aktywnych posłów X kadencji"
#| label: wiekOgolnieDescStatsTable
df |>
    filter(czyAktywny, !is.na(wiek)) |>
    summarize(
      posłów   = n(),
      wiekŚrednia  = round(mean(wiek), 2),
      wiekOdchStd  = round(sd(wiek), 2),
      wiekMin  = min(wiek),
      wiekQ1       = round(quantile(wiek, 0.25, na.rm = TRUE), 0),
      wiekMediana  = round(median(wiek), 0),
      wiekQ3       = round(quantile(wiek, 0.75, na.rm = TRUE), 0),
      wiekMaks = max(wiek)
    ) |> 
      gt()
```

```{r}
#| code-summary: "Rozkład wieku aktywnych posłów X kadencji (beeswarm plot)"
#| label: beeswarmWiekRozklad
#| fig-height: 2

df |>
  filter(czyAktywny, !is.na(wiek)) |>
  ggplot(aes(x = wiek, y = 1)) +
  geom_boxplot(
    width = 0.05, outlier.shape = NA, alpha = 0.1, color="gray50"
  ) +
  ggbeeswarm::geom_quasirandom(
    width = 0.25, alpha = 0.5, size = 1.3, color="#56B4E9"
  ) +
  scale_y_continuous(NULL, breaks = NULL) +
  scale_x_continuous(breaks = seq(25, 85, by = 5), limits = c(25, 85)) +
  labs(x="Wiek")+
  theme(
    axis.title.y = element_blank(),
    # axis.title.x = element_text("Wiek", color="black"),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.x = element_line(linetype = "dotted", alpha = .7),
    # axis.text.x = element_text(color="lightgrey")
  )
```


```{r}
#| code-summary: "Histogram wieku aktywnych posłów (podzielony na 5-letnie koszyki)"
#| label: wiekHist5YearBins
#| fig-height: 3

df |>
  filter(czyAktywny, !is.na(wiek)) |>
  ggplot(aes(x = wiek)) +
  geom_histogram(
    binwidth = 5,
    boundary = 20,
    closed   = "left",
    fill     = "#56B4E9",
    color    = "white",
    linewidth = 0.4
  ) +
  geom_text(
    stat = "bin",
    binwidth = 5,
    boundary = 20,
    closed   = "left",
    aes(
      label = after_stat(ifelse(count == 0, NA, count)),
      y     = after_stat(count)
    ),
    vjust = -0.35,
    color = "#56B4E9",
    size  = 3
  ) +
  scale_x_continuous(
    breaks = seq(20, 90, by = 5),
    limits = c(20, 90),
    expand = c(0, 0)
  ) +
  scale_y_continuous(
    breaks=seq(0, 80, by=10), limits=c(0, 80),
    expand = expansion(mult = c(0, 0.08))
  ) +
  labs(x="Wiek") +
  theme(
    axis.title.y = element_blank(),
    panel.grid.major.y = element_line(linetype = "dotted", alpha = .7),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.x = element_line(linetype = "dotted", alpha = .7),
    axis.text.y = element_text(color = "lightgrey"),
)
```  
  
Rozkład wieku aktywnych posłów ma wyraźnie „dojrzały” profil — ciężar obserwacji koncentruje się w późnych latach 40. oraz w wieku 50–60+, co sugeruje, że Sejm jest przede wszystkim instytucją kariery politycznej „środka życia”, a nie przestrzenią zdominowaną przez młodych dorosłych. Potwierdzają to miary deskryptywne: przy **n = 460** średni wiek wynosi **53.25 roku**, mediana **52**, a połowa posłów mieści się w przedziale **45–63 lat (Q1–Q3)**, co wskazuje na relatywnie stabilny „trzon” reprezentacji w wieku średnim i późno-średnim. Marginalna liczebność koszyków 25–30 i 30–35 sugeruje słabą reprezentację młodych, co można interpretować jako efekt selekcji instytucjonalnej i barier wejścia (kapitał organizacyjny, sieciowy, finansowy, rozpoznawalność) lub preferencji wyborczych wobec kandydatów postrzeganych jako „bardziej doświadczeni”. Jednocześnie średnia tylko nieznacznie przewyższająca medianę (53.25 vs 52) oraz umiarkowane zróżnicowanie wieku (**odchStd = 11.26**) sugerują brak silnej asymetrii rozkładu: obecność starszych posłów tworzy prawostronny ogon, ale nie deformuje istotnie obrazu całości. Punkty układają się w gęste, zwarte pasmo mniej więcej od końca trzydziestki do końca sześćdziesiątki, a wartości skrajne (wiek minimalny **25** i maksymalny **80**) występują incydentalnie, jako jednostkowe obserwacje. Widać też, że roczniki 70+ stanowią niewielką, lecz niezerową część składu -- co domyka rozkład jako „cienki ogon”.
  
Ciekawostka: wg portalu Genius, w czwartej zwrotce kawałka *BĘDĘ PREZYDENTEM :)* raper Mata nawija:  
  
> ,,Trzech posłów poniżej trzydziestki w sejmie -- o chuj chodzi?  
> Jak oni nie są za starzy, my nie jesteśmy za młodzi."[^geniusMata]

```{r}
#| code-summary: "Czy faktycznie mamy w sejmie trzech posłów, którzy są poniżej 30 roku życia?"
#| label: isMataRightBool
df |> 
  filter(czyAktywny, wiek<30) |> 
  nrow() >= 3
```
```{r}
#| code-summary: "Piątka najmłodszych posłów (stan na 11 stycznia 2026 r.)"
#| label: top5YoungestMPtable
df |> 
  filter(czyAktywny) |> 
  arrange(wiek, dataUr) |> 
  head(5) |> 
  select(imieNazwisko, klub, dataUr, wiek) |> 
  gt() |> 
  colorRowsByClub()
```

Okazuje się, że raper poniekąd minął się z prawdą -- zgodnie z dniem pobrania danych (11 stycznia 2026), posłów poniżej 30 roku życia w sejmie było dwoje -- Aleksandra Kot (KO; 25 lat) i Adam Gomoła (Polska2050; 26 lat). Jeśli wziąc nawet pod uwagę datę premiery numeru (25 grudnia 2025)[^geniusMata], wersy nadal nie są prawdziwe - zarówno Michał Moskal (PiS) jak i Aleksandra Karolina Uznańska-Wiśniewska (KO) mieli wtedy skończone 31 lat. Być może słowa Maty prawdziwe były w chwilii pisaina tekstu, jednak nie były aktualne już w dniu jego publikacji.  
    
Co do wersu o ,,nie byciu za młodym" -- Mata ma tutaj racje: zgodnie z art. 99 ust. 1 Konstytucji Rzeczypospolitej Polskiej z dnia 2 kwietnia 1997 r. (Dz.U. 1997 nr 78 poz. 483) ,,wybrany do Sejmu może być obywatel polski mający prawo wybierania, który najpóźniej w dniu wyborów kończy 21 lat"[^konst21Lat]. Raper ma obecnie skończone 25 lat[^mataWiek], więc nie jest za młody, aby zostać wybrany na posła RP. Do uzyskania możliwości startowania w wyborach prezydenckich brakuje mu natomiast 10 lat[^konstPrezydentWiek].


```{r}
#| code-summary: "Statystyki deksryptywne wieku aktywnych posłów X kadencji wg klubów"
#| label: wiekPartieTableDescStats
df |> 
  filter(czyAktywny) |> 
  group_by(klub) |> 
  summarize( 
    posłów = n(),
    wiekŚrednia  = round(mean(wiek), 2),
      wiekOdchStd  = round(sd(wiek), 2),
      wiekMin  = min(wiek),
      wiekQ1       = round(quantile(wiek, 0.25, na.rm = TRUE), 0),
      wiekMediana  = round(median(wiek), 0),
      wiekQ3       = round(quantile(wiek, 0.75, na.rm = TRUE), 0),
      wiekMaks = max(wiek),
    .groups   = "drop"
  ) |> 
  arrange(wiekMediana) |> 
  gt() |> 
  colorRowsByClub()
```

```{r}
#| code-summary: "Rozkłady wieku aktywnych posłów X kadencji wg klubów -- sortowanie rosnące wg mediany"
#| label: wiekPartieBoxMedian
#| fig-height: 5

df2 <- df |>
  filter(!is.na(wiek), !is.na(klub), czyAktywny) |>
  mutate(klub = forcats::fct_reorder(klub, wiek, median, .desc = TRUE))

lab_df <- df2 |>
  count(klub, name = "n") |>
  mutate(label = paste0(as.character(klub), "  (n=", n, ")"))

med_df <- df2 |>
  group_by(klub) |>
  summarise(med = median(wiek, na.rm = TRUE), .groups = "drop")

x_min <- min(df2$wiek, na.rm = TRUE)
x_max <- max(df2$wiek, na.rm = TRUE)

ggplot(df2, aes(x = wiek, y = klub, fill = klub)) +
  geom_violin(trim = FALSE, alpha = 0.25, color = NA) +
  geom_boxplot(width = 0.18, outlier.shape = NA, alpha = 0.35) +
  geom_text(
    data = med_df,
    aes(x = med + 0.6, y = klub, label = round(med, 0), color = klub),
    inherit.aes = FALSE,
    vjust = -1.15,
    hjust = .95,
    size = 3,
    show.legend = FALSE,

  ) +
  geom_jitter(aes(color = klub), height = 0.12, width = 0, alpha = 0.45, size = 1.3, show.legend = FALSE) +
  geom_text(
    data = lab_df,
    aes(x = x_min - 1.75, y = klub, label = label, color = klub),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3.5,
    show.legend = FALSE
  ) +
  scale_fill_manual(values = club_palette_core) +
  scale_color_manual(values = club_palette_core, guide = "none") +
  coord_cartesian(xlim = c(x_min - 8, x_max + 2), clip = "off") +
  scale_x_continuous(breaks = seq(25, 85, by = 5)) +
  labs(x="Wiek")+
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major.y = element_blank(),
    plot.margin = margin(5.5, 5.5, 5.5, 40),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.x = element_line(linetype = "dotted", alpha = .7),
    # axis.text.x = element_text(color="black")
  )
```

Wiek aktywnych posłów wyraźnie różni się między klubami, a porządek po medianie pokazuje spójną „oś pokoleniową” sceny parlamentarnej: najmłodszy profil ma **Konfederacja** (mediana **40**, średnia **42.44**, IQR **39–45**, n=16), relatywnie młode są też małe kluby **Razem** (mediana **46**, n=4) i **Polska 2050** (mediana **49**, n=31), podczas gdy **KO** lokuje się w środku (mediana **52**, n=156). Najwyższe mediany mają duże kluby **PiS** i **PSL** (obie po **56**, przy większym rozrzucie, zwłaszcza w PiS: IQR **44–65**, n=188), co wskazuje na bardziej doświadczoną, starszą strukturę wieku. Kluby o dużych liczebnościach (KO, PiS, PSL) mają nie tylko wyższe mediany, ale też szersze spektrum wieku, natomiast małe grupy wyglądają na bardziej zbite/homogeniczne wiekowo -- choć bardzo małych próbach (n=3–4) te wartości należy traktować ostrożnie jako opis stanu, a nie stabilną cechę elektoratu czy rekrutacji.

## Płeć


```{r}
#| code-summary: "Odsetek kobiet i mężczyzn wśród aktywnych posłów X kadencji"
#| label: plcieTable

df |>
  filter(czyAktywny, !is.na(plec)) |>
  mutate(
    plec = case_when(
      plec %in% c("M", "mężczyzna", "Mężczyzna", "Mezczyzna") ~ "Mężczyźni",
      plec %in% c("K", "kobieta", "Kobieta") ~ "Kobiety",
      TRUE ~ NA_character_
    )
  ) |>
  filter(!is.na(plec)) |>
  count(plec, name = "n") |>
  mutate(
    total = sum(n),
    pct = n / total
  ) |>
  select(plec, n, pct) |>
  mutate(pct = scales::percent(pct, accuracy = 0.1)) |>
  arrange(desc(n)) |> 
  gt() |>
  cols_label(plec = "Płeć", n = "Liczba", pct = "Odsetek") |>
  # kolorowanie całych wierszy (alpha = 0.35)
  tab_style(
    style = cell_fill(color = alpha(sex_palette[["Kobiety"]], 0.35)),
    locations = cells_body(rows = plec == "Kobiety")
  ) |>
  tab_style(
    style = cell_fill(color = alpha(sex_palette[["Mężczyźni"]], 0.35)),
    locations = cells_body(rows = plec == "Mężczyźni")
  )
```
```{r}
#| code-summary: "Aktywni posłowie X kadencji wg płci – symulacja sali sejmowej"
#| label: ggparlimentPlcie
library(shadowtext)
library(scales)


levels_order <- c("Mężczyźni","Kobiety")

# paleta dla płci (podmień kolory jak chcesz)
seats <- df |>
  filter(czyAktywny, !is.na(plec)) |>
  mutate(
    plec = case_when(
      plec %in% c("M", "mężczyzna", "Mężczyzna", "Mezczyzna") ~ "Mężczyźni",
      plec %in% c("K", "kobieta", "Kobieta") ~ "Kobiety",
      TRUE ~ NA_character_
    )
  ) |>
  filter(!is.na(plec)) |>
  count(plec, name = "seats") |>
  mutate(party = factor(plec, levels = levels_order)) |>
  arrange(party)

layout <- ggparliament::parliament_data(
  election_data = NULL,
  party_seats   = seats$seats,
  type          = "semicircle",
  parl_rows     = 10
)

# promieniście: po kącie + po promieniu
layout <- layout |>
  mutate(r = sqrt(x^2 + y^2)) |>
  arrange(desc(theta), desc(r))

layout$party <- rep(as.character(seats$party), seats$seats)
layout$party <- factor(layout$party, levels = levels_order)

total_seats <- 460L

sex_stats <- seats |>
  transmute(
    party   = as.character(party),
    pct     = seats / total_seats,
    pct_lab = scales::percent(pct, accuracy = 1)
  )

# pozycje etykiet: "pusty środek" półokręgu (promień mniejszy niż najbliższe punkty danej płci)
layout_lab <- layout |>
  mutate(
    r      = sqrt(x^2 + y^2),
    theta2 = atan2(y, x)
  ) |>
  group_by(party) |>
  summarise(
    theta = median(theta2),
    rmin  = min(r),
    rmax  = max(r),
    .groups = "drop"
  ) |>
  mutate(
    # ŚRODEK "grubości" sektora (wewnątrz niebieskiego/różowego, a nie w pustym środku)
    alpha = if_else(party == "Mężczyźni", 0.60, 0.55),  # drobna asymetria działa lepiej wizualnie
    r_lab = rmin + alpha * (rmax - rmin),

    # opcjonalny mikronudge "po łuku", żeby nie siadało idealnie na kropce
    t_nudge = 0.06 * (rmax - rmin),
    x_lab = r_lab * cos(theta) + t_nudge * (-sin(theta)),
    y_lab = r_lab * sin(theta) + t_nudge * ( cos(theta))
  ) |>
  select(-alpha, -t_nudge) |>
  left_join(sex_stats, by = "party")

ggplot(layout, aes(x, y, colour = party)) +
  geom_point(size = 5) +
  shadowtext::geom_shadowtext(
    data = layout_lab,
    aes(x = x_lab, y = y_lab, label = pct_lab, colour = party),
    inherit.aes = FALSE,
    fontface = "bold",
    size = 5,                                # lekko mniejsze
    bg.colour = scales::alpha("white", 0.95),  # biały obrys
    bg.r = 0.22,                               # grubość obrysu (0.15–0.28)
    show.legend = FALSE
  ) +
  coord_equal(clip = "off") +
  scale_colour_manual(values = sex_palette, labels = sex_labels) +
  theme_void() +
  theme(legend.position = "bottom", legend.title = element_blank(),
  legend.text = ggtext::element_markdown())
```

```{r}
#| code-summary: "Podział płci wg członków klubów X kadencji -- sortowanie wg odsetka kobiet"
#| label: plciPartieStackedBarr100
# library(dplyr)
# library(ggplot2)
# library(forcats)
# library(scales)
# library(ggtext)

sex_palette <- c(
  "Mężczyźni" = "#2C7FB8",
  "Kobiety"   = "#C51B7D"
)

sex_order  <- c("Mężczyźni", "Kobiety")
sex_values <- sex_palette[sex_order]
sex_labels <- setNames(
  sprintf("<span style='color:%s'>%s</span>", sex_values, names(sex_values)),
  names(sex_values)
)

df_g <- df |>
  filter(czyAktywny, !is.na(klub), !is.na(plec)) |>
  mutate(
    plec = case_when(
      plec == "M" ~ "Mężczyźni",
      plec == "K" ~ "Kobiety",
      TRUE ~ NA_character_
    ),
    plec = factor(plec, levels = sex_order)
  ) |>
  filter(!is.na(plec))

share_df <- df_g |>
  count(klub, plec, name = "n") |>
  group_by(klub) |>
  mutate(total = sum(n), prop = n / total) |>
  ungroup()

women_df <- share_df |>
  filter(plec == "Kobiety") |>
  transmute(klub, women_share = prop)

women_df <- share_df |>
  distinct(klub, total) |>
  left_join(women_df, by = "klub") |>
  mutate(
    women_share = coalesce(women_share, 0),
    klub = fct_reorder(klub, women_share, .desc = FALSE),
    label = paste0(as.character(klub), "  (n=", total, ")")
  )

share_df <- share_df |>
  left_join(women_df |> select(klub, women_share), by = "klub") |>
  mutate(
    klub = fct_reorder(klub, women_share, .desc = FALSE),
    pct_lab = scales::percent(prop, accuracy = 1)
  )

# etykiety wewnątrz segmentów tylko dla klubów, które mają kobiety
inside_df <- share_df |>
  filter(women_share > 0, prop > 0)

# 0% po prawej dla klubów bez kobiet
zero_df <- women_df |>
  filter(women_share == 0) |>
  mutate(women_lab = "0%")

men100_df <- women_df |>
  filter(women_share == 0) |>
  mutate(men_lab = "100%")

ggplot(share_df, aes(x = prop, y = klub, fill = plec)) +
  geom_col(width = 0.75, position = position_stack(reverse = TRUE)) +

  # label klubu po lewej (kolor wg palety klubów)
  geom_text(
    data = women_df,
    aes(x = -0.01, y = klub, label = label, color = klub),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3.5,
    show.legend = FALSE
  ) +

  # procenty w środku KAŻDEGO segmentu (białe) – ale tylko tam, gdzie są kobiety
  geom_text(
    data = inside_df,
    aes(label = pct_lab),
    position = position_stack(vjust = 0.5, reverse = TRUE),
    inherit.aes = TRUE,
    color = "white",
    fontface = "bold",
    size = 3.2,
    show.legend = FALSE
  ) +

  # 0% po prawej (czarne, bo białe tło)
  geom_text(
    data = zero_df,
    aes(x = 1.02, y = klub, label = women_lab),
    inherit.aes = FALSE,
    color = "black",
    hjust = 0,
    size = 3.2,
    show.legend = FALSE
  ) +

  geom_text(
    data = men100_df,
    aes(x = 0.5, y = klub, label = men_lab),
    inherit.aes = FALSE,
    color = "white",
    fontface = "bold",
    size = 3.2,
    show.legend = FALSE
  ) +
  scale_fill_manual(values = sex_values, labels = sex_labels) +
  scale_color_manual(values = club_palette_core, guide = "none") +
  scale_x_continuous(
    labels = percent_format(accuracy = 1),
    breaks = seq(0, 1, by = 0.1),
    expand = c(0, 0)
  ) +
  coord_cartesian(xlim = c(-0.25, 1.08), clip = "off") +
  labs(x = "Udział w klubie", y = NULL, fill = NULL) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.text = ggtext::element_markdown(),
    axis.text.y  = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.x = element_line(linetype = "dotted", alpha = .7),
    axis.title.x = element_blank(),
    axis.text.x = element_text(color = "lightgray")
  )

```

Struktura płci wśród aktywnych posłów X kadencji pozostaje wyraźnie asymetryczna: mężczyźni stanowią ok. 68,5% składu (315 osób), a kobiety 31,5% (145), co potwierdza, że mimo formalnych mechanizmów równościowych reprezentacja kobiet wciąż nie osiąga poziomu „równowagi” demograficznej. Ciekawe spostrzeżenie wyłania się, gdy spojrzymy na rozkład płci w poszczególnych klubach -- jeśli posortujemy malejąco względem odsetka kobiet w ugrupowaniu, dostaniemy wręcz ,,wzorcowy" podział światopoglądowy od lewicy, przez bliżej niezdefiniowane centrum, liberałów, centroprawicę aż do skrajnej prawicy. Może to sugerować, iż obserwowana nierównowaga wynika z odmiennych strategii rekrutacyjnych, profili elektoratu i wewnętrznych praktyk organizacyjnych. W efekcie, agregatowy wynik dla całego Sejmu maskuje istotną polaryzację: część klubów „ciągnie” średnią w stronę większej reprezentacji kobiet, podczas gdy inne utrzymują skład niemal wyłącznie męski -- a to ma konsekwencje dla tego, jak reprezentacja społeczna jest rozłożona w ramach realnych bloków głosowań i koalicji.


## Edukacja
```{r}
#| code-summary: "Rodzaje wykształcenia wśród aktywnych posłów X kadencji"
#| label: wyksztalcenieBarChart
#| fig-height: 3

df |>
  filter(czyAktywny) |>
  count(wyksztalcenie, name = "liczba") |>
  ggplot(aes(x = reorder(wyksztalcenie, desc(liczba)), y = liczba)) +
  geom_col(fill = "#56B4E9", width = .5) +
  geom_text(aes(label = liczba), vjust = -0.35, color = "#56B4E9", size = 5) +
  scale_y_continuous(breaks = seq(0, 450, by = 50), limits = c(0, 450)) +
  theme(
    axis.title = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_line(linetype = "dotted", color = "lightgray"),
    axis.text.y = element_text(color = "lightgrey"),
    # TO DZIAŁA: podnosi etykiety osi X (bliżej panelu/słupków)
    axis.ticks.length = grid::unit(-10, "mm"),
    # żeby nie rozwalić osi Y (opcjonalnie)
    axis.ticks.length.y = grid::unit(100, "mm"),
    axis.text.x = element_text(color = "black")
  )
```

```{r}
#| code-summary: "Najwyższe uzyskane stopnie naukowe wśród aktywnych posłów X kadencji"
#| label: stopnieNaukBarChart
#| fig-height: 3

levels_deg_abbrev <- c("wykszt. śr.", "tyt. zaw.", "I st.", "II st.", "dr", "dr hab.", "prof.")

deg_bins <- df |>
  filter(czyAktywny, !is.na(klub)) |>
  mutate(
    kategoria = case_when(
      # wszystko niższe niż wyższe (albo brak) -> wyksz. śr.
      is.na(wyksztalcenie) | wyksztalcenie != "wyższe" ~ "wykszt. śr.",

      # wyższe -> rozbij wg najwyższego stopnia
      najwyzszyStopienNaukowy == "profesor" ~ "prof.",
      najwyzszyStopienNaukowy == "doktor habilitowany" ~ "dr hab.",
      najwyzszyStopienNaukowy == "doktor" ~ "dr",
      najwyzszyStopienNaukowy %in% c("magister", "magister inżynier") ~ "dr hab.",
      najwyzszyStopienNaukowy %in% c("licencjat", "inżynier") ~ "I st.",
      TRUE ~ "tyt. zaw."
    ),
    kategoria = factor(kategoria, levels = levels_deg_abbrev)
  ) |>
  count(kategoria, name = "n") |>
  mutate(p = n / sum(n))

ggplot(deg_bins, aes(x = kategoria, y = n)) +
  geom_col(fill = "#56B4E9", width = 0.7) +
  geom_text(aes(label = n), vjust = -0.2, size = 5, color = "#56B4E9") +
  scale_y_continuous(
    breaks = seq(0, 350, by = 50),
    limits = c(0, 350)
  ) +
  labs(x = NULL, y = NULL) +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_line(linetype="dotted", color="lightgray"),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(color = "black"),
    axis.text.y = element_text(color = "lightgray")
  )

```

```{r}
#| code-summary: "Odsetek najwyższych uzyskanych stopni naukowych wg klubów"
#| label: stopnieOdsetekHeatMap

levels_deg <- c(
  "prof.","dr hab.","dr",
  "II st.","I st.","tyt. zaw.",
  "wykszt. śr."
)

# 1) Denominator: wszyscy aktywni posłowie w klubie
club_totals <- df |>
  filter(czyAktywny, !is.na(klub)) |>
  count(klub, name = "total")

# 2) Liczniki dla "wyższe" w rozbiciu na stopnie/kategorie
higher_counts <- df |>
  filter(czyAktywny, wyksztalcenie == "wyższe", !is.na(klub)) |>
  mutate(
    kategoria = case_when(
      is.na(wyksztalcenie) | wyksztalcenie != "wyższe" ~ "wykszt. śr.",
      najwyzszyStopienNaukowy == "profesor" ~ "prof.",
      najwyzszyStopienNaukowy == "doktor habilitowany" ~ "dr hab.",
      najwyzszyStopienNaukowy == "doktor" ~ "dr",
      najwyzszyStopienNaukowy %in% c("magister", "magister inżynier") ~ "II st.",
      najwyzszyStopienNaukowy %in% c("licencjat", "inżynier") ~ "I st.",
      TRUE ~ "tyt. zaw."
    ),
    kategoria = factor(kategoria, levels = levels_deg)
  ) |>
  count(klub, kategoria, name = "n")

# 3) Licznik dla "wykształcenie < wyższe" (twardo z danych, a nie z reszty)
lower_counts <- df |>
  filter(czyAktywny, !is.na(klub)) |>
  filter(is.na(wyksztalcenie) | wyksztalcenie != "wyższe") |>
  count(klub, name = "n") |>
  mutate(kategoria = factor("wykszt. śr.", levels = levels_deg))

# 4) Sklej wszystko + dopełnij siatkę do pełnej macierzy klub x kategoria
deg_by_club_pct <- expand_grid(
    klub = club_totals$klub,
    kategoria = factor(levels_deg, levels = levels_deg)
  ) |>
  left_join(club_totals, by = "klub") |>
  left_join(higher_counts, by = c("klub", "kategoria")) |>
  left_join(lower_counts,  by = c("klub", "kategoria"), suffix = c("", "_low")) |>
  mutate(
    # bierz n z higher_counts; dla ostatniej kategorii bierz n_low
    n = if_else(
      kategoria == "wykszt. śr.",
      coalesce(n_low, 0L),
      coalesce(n, 0L)
    ),
    pct = if_else(total > 0, 100 * n / total, 0),
    pct = coalesce(pct, 0),
    label = paste0(sprintf("%.0f", pct), "%")
  ) |>
  select(klub, kategoria, n, total, pct, label)

# --- deg_by_club_pct: zakładam, że już masz policzone jak wcześniej ---
# musi mieć kolumny: klub, kategoria, pct, label
# oraz masz club_palette_core

# 1) Porządek klubów: profesor -> dr hab -> dr -> ... (malejąco)
club_order <- deg_by_club_pct |>
  mutate(kategoria = factor(kategoria, levels = levels_deg)) |>
  select(klub, kategoria, pct) |>
  tidyr::pivot_wider(names_from = kategoria, values_from = pct, values_fill = 0) |>
  arrange(
    desc(`prof.`),
    desc(`dr hab.`),
    desc(`dr`),
    desc(`II st.`),
    desc(`I st.`),
    desc(`tyt. zaw.`),
    desc(`wykszt. śr.`)
  ) |>
  pull(klub)

deg_by_club_pct <- deg_by_club_pct |>
  mutate(
    klub = factor(klub, levels = club_order),
    kategoria = factor(kategoria, levels = levels_deg),
    label = if_else(is.na(label) | label == "", "0%", label)  # awaryjnie
  )

# 2) Etykiety osi Y w kolorach klubów + (n=...)
y_lab_df <- df |>
  filter(czyAktywny, !is.na(klub)) |>
  count(klub, name = "total") |>
  mutate(
    klub = factor(klub, levels = club_order),
    label = paste0(as.character(klub), "  (n=", total, ")")

  )

# 3) Nieliniowy gradient (większa rozdzielczość na dole)
vals <- rescale(c(0, 1, 5, 10, 20, 40, 60, 80, 100), to = c(0, 1))

ggplot(deg_by_club_pct, aes(x = kategoria, y = klub, fill = pct)) +
  geom_tile(color = "white", linewidth = 0.6) +
  geom_text(aes(label = paste0(sprintf("%.0f", pct), "%")), size = 3) +

  # kolorowe etykiety klubów (zamiast axis.text.y)
  geom_text(
    data = y_lab_df,
    aes(x = 0.35, y = klub, label = label, color = klub),
    inherit.aes = FALSE,
    hjust = 1,
    size = 3.6,
    show.legend = FALSE
  ) +

  scale_fill_gradientn(
    colours = c("#FFFFFF", "#56B4E9", "#0072B2"),
    values  = vals,
    limits  = c(0, 100),
    breaks  = c(0, 1, 5, 10, 20, 40, 60, 80, 100),
    labels  = function(x) paste0(x, "%"),
    name    = "% w klubie",
    guide = guide_colorbar(
      ticks.colour = "grey40",
      frame.colour = "grey60"
    )
  ) +
  scale_color_manual(values = club_palette_core, guide = "none") +
  coord_cartesian(clip = "off") +
  scale_x_discrete(drop = FALSE, limits=rev) +
  scale_y_discrete(drop = FALSE, limits=rev) +

  labs(x = NULL, y = NULL) +
  theme_minimal(base_size = 11) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(color="black"),

    axis.text.y  = element_blank(),
    axis.ticks.y = element_blank(),


    legend.position = "none",
    plot.margin = margin(t = 8, r = 24, b = 8, l = 120)
  )

```

Wśród posłów X kadencji widać bardzo silną dominację wykształcenia wyższego (435 osób), przy marginalnym udziale wykształcenia średniego (łącznie 25 osób w trzech kategoriach) oraz zawodowego (4 osoby). Gdy spojrzeć na najwyższy poziom formalnych kwalifikacji, trzonem profilu edukacyjnego jest wykształcenie II stopnia (magisterskie lub równoważne) -- w większości klubów stanowi ono ok. 56-–80% składu -- a kolejną istotną grupą są osoby ze stopniem doktora (najczęściej jednocyfrowe lub kilkunastoprocentowe wartości, z wyższymi udziałami m.in. w PSL i Lewicy). Stopnie habilitowane i profesorskie pojawiają się incydentalnie (zwykle 0-–1%), co sugeruje, że elita akademicka sensu stricto jest w Sejmie reprezentowana sporadycznie, natomiast „dominującą normą” pozostaje wyższe wykształcenie cywilne bez najwyższych stopni naukowych.


```{r}
# df_base <- df |> dplyr::filter(czyAktywny)

df_base <- df |>
  filter(czyAktywny) |> 
  mutate(
    liczbaStudiowPodyplomowych = as.integer(liczbaStudiowPodyplomowych),
    ma_podyplomowe = liczbaStudiowPodyplomowych > 0
  )

# # helper: jeśli masz w QMD funkcję gt_default(), to automatycznie ją zastosujemy
apply_gt_default <- function(x) if (exists("gt_default")) gt_default(x) else x


# 1) Ma jakiekolwiek podyplomowe vs brak (liczba + odsetek)
tbl1 <- df_base |>
  count(ma_podyplomowe, name = "liczba") |>
  mutate(
    odsetek = liczba / sum(liczba),
    kategoria = if_else(ma_podyplomowe, "Ma jakiekolwiek studia podyplomowe (≥1)", "Brak studiów podyplomowych (0)")
  ) |>
  select(kategoria, liczba, odsetek)

tbl1 |>
  gt() |>
  cols_label(kategoria = "Kategoria", liczba = "Liczba", odsetek = "Odsetek") |>
  fmt_number(columns = liczba, decimals = 0) |>
  fmt_percent(columns = odsetek, decimals = 1) |>
  apply_gt_default()
```

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(scales)

tbl2 <- df_base |>
  count(liczbaStudiowPodyplomowych, name = "liczba") |>
  tidyr::complete(liczbaStudiowPodyplomowych = 0:6, fill = list(liczba = 0)) |>
  arrange(liczbaStudiowPodyplomowych) |>
  mutate(
    odsetek = liczba / sum(liczba),
    label = if_else(
      liczba == 0,
      "",
      paste0(liczba, " (", percent(odsetek, accuracy = 0.1), ")")
    )
  )

ggplot(tbl2, aes(x = factor(liczbaStudiowPodyplomowych), y = liczba)) +
  geom_col(width = 0.8, fill="#56B4E9") +  # dane są już policzone -> geom_col() / stat_identity :contentReference[oaicite:0]{index=0}
  geom_text(aes(label = label), vjust = -0.4, lineheight = 0.9, color="#56B4E9", size=4) + # etykiety nad słupkami :contentReference[oaicite:1]{index=1}
  scale_y_continuous(
    breaks=seq(0, 275, by=25), limits=c(0, 275)) +
  labs(
    x = "Liczba ukończonych studiów podyplomowych",
  )+
  theme(
    axis.title.y = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.major.y = element_line(linetype="dotted", color="lightgray"),
    axis.text.x = element_text(color="black",  margin = margin(t = -20)),
    axis.text.y = element_text(color="lightgray")
  )

```


```{r}
club_order <- df_base |> count(klub, name = "N") |> arrange(desc(N)) |> pull(klub)

heat_df <- df_base |>
  count(klub, liczbaStudiowPodyplomowych, name = "liczba") |>
  group_by(klub) |>
  mutate(
    odsetek_w_klubie = liczba / sum(liczba)
  ) |>
  ungroup() |>
  tidyr::complete(
    klub = club_order,
    liczbaStudiowPodyplomowych = 0:6,
    fill = list(liczba = 0, odsetek_w_klubie = 0)
  ) |>
  mutate(
    klub = factor(klub, levels = club_order),
    label_np = sprintf("%d\n(%s)", liczba, percent(odsetek_w_klubie, accuracy = 0.1))
  )

# 3a) Heatmap odsetka (w ramach klubu) + etykieta: liczba i odsetek
ggplot(heat_df, aes(x = liczbaStudiowPodyplomowych, y = klub, fill = odsetek_w_klubie)) +
  geom_tile() +
  geom_text(aes(label = label_np), size = 3, lineheight = 0.9) +
  # geom_text(
  #   data = y_lab_df,
  #   aes(x = 0.35, y = klub, label = label, color = klub),
  #   inherit.aes = FALSE,
  #   hjust = 1,
  #   size = 3.6,
  #   show.legend = FALSE
  # ) +
  scale_x_continuous(breaks = 0:6) +
  scale_fill_gradientn(
    colours = c("#FFFFFF", "#56B4E9", "#0072B2"),
    values  = vals,
    limits  = c(0, 6),
    breaks  = c(0, 1, 2, 3, 4, 5, 6),
    labels  = function(x) paste0(x, "%"),
    name    = "% w klubie",
    guide = guide_colorbar(
      ticks.colour = "grey40",
      frame.colour = "grey60"
    )
  )+
  labs(
    x = "Liczba ukończonych studiów podyplomowych",
    fill = "Odsetek w klubie"
  ) + 
  theme(axis.ticks.y = element_blank())
```

# Eksploracja korelacji

```{r}
df |> 
  select(-id) |> 
  select(where(is.numeric)) |> 
  cor() |> 
  reshape2::melt() |> 
  ggplot()+
  aes(x = Var1, y = Var2, fill = value) +
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Correlation") +
  theme_minimal() +
  labs(title = "Correlation Heatmap of Numeric Variables") +
  # Adds correlation values as text labels
  geom_text(aes(label = round(value, 2)), color = "black", size = 3) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                   size = 10, hjust = 1))
```

```{r}

library(ggplot2)
library(ggpubr)

ggplot(df, aes(x = ktoraKadencja, y = wiek)) +
  geom_point() +
  geom_smooth(method = "lm", color = "blue", fill = "lightblue") +
  stat_cor(
    aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")),
    label.x.npc = "center",
    label.y.npc = "top"
  ) +
  labs(
    title = "Linear Correlation between Kadencja and Wiek",
    x = "Ktora Kadencja",
    y = "Wiek"
  ) +
  theme_minimal()
```


---

```{r}
library(tidyverse)
library(scales)
library(ggtext)
library(ggrepel)

knitr::opts_chunk$set(
  fig.width = 10,
  fig.align = "center",
  dpi = 320,
  out.width = "100%"
)

# minimalist replacements for tidytext::reorder_within / scale_y_reordered
reorder_within <- function(x, by, within, fun = mean, sep = "___") {
  new_x <- paste(x, within, sep = sep)
  stats::reorder(new_x, by, FUN = fun)
}
scale_y_reordered <- function(..., sep = "___", labels_wrap = NULL) {
  base_lab <- function(x) gsub(paste0(sep, ".*$"), "", x)
  lab_fun <- if (is.null(labels_wrap)) base_lab else function(x) stringr::str_wrap(base_lab(x), labels_wrap)
  scale_y_discrete(labels = lab_fun, ...)
}

club_colors <- c(
  "PiS"              = "#012B7F",
  "KO"               = "#FF7F2A",
  "PSL"              = "#30D397",
  "Polska2050"       = "#FFC302",
  "Lewica"           = "#D62943",
  "Konfederacja"     = "#153560",
  "Konfederacja_KP"  = "#A27819",
  "Razem"            = "#870E57",
  "Republikanie"     = "#15233F",
  "niez."            = "#7A7A7A"
)

club_order <- names(club_colors)

theme_set(
  theme_minimal(base_family = "Calibri", base_size = 12) +
    theme(
      plot.title.position   = "plot",
      plot.caption.position = "plot",
      panel.grid.minor      = element_blank(),
      legend.position       = "right"
    )
)
```

# Text Mining

```{r data}
tfidf      <- read_csv("/Users/krzysztofstawarz/GithubRepositories/textMiningLingwistykaSejmowa/4textMining/data/processed/tfidf_top_terms.csv")
tfidf_ng   <- read_csv("/Users/krzysztofstawarz/GithubRepositories/textMiningLingwistykaSejmowa/4textMining/data/processed/tfidf_top_ngrams.csv")
styles     <- read_csv("/Users/krzysztofstawarz/GithubRepositories/textMiningLingwistykaSejmowa/4textMining/data/processed/style_metrics.csv")
dumbbell   <- read_csv("/Users/krzysztofstawarz/GithubRepositories/textMiningLingwistykaSejmowa/4textMining/data/processed/sentiment_dumbbell.csv")
topics_mix <- read_csv("/Users/krzysztofstawarz/GithubRepositories/textMiningLingwistykaSejmowa/4textMining/data/processed/lda_topic_mix.csv")
topics     <- read_csv("/Users/krzysztofstawarz/GithubRepositories/textMiningLingwistykaSejmowa/4textMining/data/processed/lda_topics.csv")
topic_lbl  <- read_csv("/Users/krzysztofstawarz/GithubRepositories/textMiningLingwistykaSejmowa/4textMining/data/processed/lda_topic_labels.csv")
log_odds   <- read_csv("/Users/krzysztofstawarz/GithubRepositories/textMiningLingwistykaSejmowa/4textMining/data/processed/comparison_log_odds.csv")
name_cnt   <- read_csv("/Users/krzysztofstawarz/GithubRepositories/textMiningLingwistykaSejmowa/4textMining/data/processed/name_counts.csv")

tfidf <- tfidf |> mutate(club = factor(group, levels = club_order))
tfidf_ng <- tfidf_ng |> mutate(club = factor(group, levels = club_order))
styles <- styles |> mutate(club = factor(club, levels = club_order))
dumbbell <- dumbbell |> mutate(club = factor(club, levels = club_order))
topics_mix <- topics_mix |> mutate(club = factor(club, levels = club_order),
                                   topic = factor(topic))
topics     <- topics     |> mutate(topic = factor(topic))
topic_lbl  <- topic_lbl  |> mutate(topic = factor(topic))

delta_top <- dumbbell |> arrange(desc(delta)) |> slice(1)
fog_gap <- styles |> select(club, source, fog_mean) |>
  pivot_wider(names_from = source, values_from = fog_mean) |>
  mutate(delta = stenogram - interpelacja) |>
  arrange(delta) |> slice(1)
```

**Snapshot wniosków (inline):**

- Największy wzrost negatywności między interpelacjami a wystąpieniami ma klub *`r delta_top$club`* (`r scales::number(delta_top$delta, accuracy = 0.01)` punktu sentymentu).
- Najbardziej „uprościli" język na mównicy posłowie *`r fog_gap$club`* (FOG ↓ o `r scales::number(-fog_gap$delta, accuracy = 0.01)` względem interpelacji).

## Słowa charakterystyczne (TF–IDF)

```{r tfidf_plots}
plot_tfidf <- function(src_label) {
  tfidf |>
    filter(source == src_label) |>
    group_by(club) |>
    slice_max(score, n = 10, with_ties = FALSE) |>
    ungroup() |>
    mutate(term = reorder_within(term, score, club)) |>
    ggplot(aes(score, term, fill = club)) +
    geom_col() +
    facet_wrap(~club, scales = "free_y") +
    scale_y_reordered() +
    scale_fill_manual(values = club_colors, guide = "none") +
    labs(
      x = "Średni TF–IDF w klubie",
      y = NULL,
      title = paste("Najbardziej partyjne słowa –", src_label)
    )
}

plot_tfidf("interpelacja")
plot_tfidf("stenogram")

## 1a. Najmocniejsze bi- i trigrama

```{r tfidf_ngrams}
plot_ng <- function(src_label) {
  tfidf_ng |>
    filter(source == src_label) |>
    group_by(club) |>
    slice_max(score, n = 6, with_ties = FALSE) |>
    ungroup() |>
    mutate(term_wrap = stringr::str_wrap(term, 26),
           term = reorder_within(term_wrap, score, club)) |>
    ggplot(aes(score, term, fill = club)) +
    geom_col() +
    facet_wrap(~club, scales = "free_y") +
    scale_y_reordered(labels_wrap = 26) +
    scale_fill_manual(values = club_colors, guide = "none") +
    labs(
      x = "Średni TF–IDF (bi-/tri-gramy) w klubie",
      y = NULL,
      title = paste("Zbite frazy partyjne –", src_label)
    )
}

plot_ng("interpelacja")
plot_ng("stenogram")
```

## Sentyment: pismo vs. mowa (dumbbell)

```{r dumbell}
db_df <- dumbbell |>
  pivot_longer(cols = c(interpelacja, stenogram), names_to = "source", values_to = "sent") |>
  mutate(source = recode(source, interpelacja = "Interpelacje", stenogram = "Stenogramy"))

ggplot(db_df, aes(sent, club, color = source)) +
  geom_line(aes(group = club), color = "grey70", linewidth = 0.8) +
  geom_point(size = 3) +
  scale_color_manual(values = c("Interpelacje" = "#6c9ef0", "Stenogramy" = "#f05c5c")) +
  labs(
    x = "Średni sentyment (lexykalny, wyższy = bardziej pozytywny)",
    y = NULL,
    title = "Zmiana wydźwięku: formalne pisma vs. wystąpienia na sali"
  )
```

**Kto jest najbardziej „na minusie”?**

```{r sentiment-ranking}
styles |>
  select(club, source, sentiment_mean) |>
  mutate(source = recode(source, interpelacja = "Interpelacje", stenogram = "Stenogramy")) |>
  ggplot(aes(sentiment_mean, fct_reorder(club, sentiment_mean), fill = source)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.65) +
  scale_fill_manual(values = c("Interpelacje" = "#6c9ef0", "Stenogramy" = "#f05c5c")) +
  labs(
    x = "Średni sentyment (ujemny = bardziej krytyczny)",
    y = NULL,
    title = "Ranking średniego wydźwięku w klubach",
    caption = "Lexykalny słownik wydźwięku; wartości około 0 = neutralne."
  )
```

## Złożoność języka (FOG) a kanał komunikacji

```{r fog}
fog_df <- styles |>
  select(club, source, fog_mean) |>
  pivot_wider(names_from = source, values_from = fog_mean) |>
  mutate(diff = stenogram - interpelacja)

ggplot(fog_df, aes(interpelacja, stenogram, label = club, color = club)) +
  geom_abline(linetype = "dashed", color = "grey60") +
  geom_point(size = 3) +
  geom_text_repel(size = 3, show.legend = FALSE) +
  scale_color_manual(values = club_colors) +
  labs(
    x = "FOG w interpelacjach (bardziej oficjalny)",
    y = "FOG w stenogramach (spontaniczny)",
    title = "Złożoność wypowiedzi: formalny vs. spontaniczny rejestr",
    caption = "FOG=0.4·(średnia długość zdania + % słów z ≥3 sylabami)"
  )
```

**Ranking mediany FOG (posortowany)**

```{r fog-median}
styles |>
  mutate(source = recode(source, interpelacja = "Interpelacje", stenogram = "Stenogramy")) |>
  group_by(source) |>
  mutate(club_ord = reorder_within(club, fog_median, source)) |>
  ungroup() |>
  ggplot(aes(fog_median, club_ord, fill = source)) +
  geom_col(width = 0.7, position = position_dodge(width = 0.8)) +
  scale_y_reordered() +
  scale_fill_manual(values = c("Interpelacje" = "#6c9ef0", "Stenogramy" = "#f05c5c")) +
  labs(
    x = "Mediana FOG",
    y = NULL,
    title = "Kto mówi najprościej? (niższy FOG = prostszy język)"
  )
```

**Czy prostszy język idzie w parze z większym sentymentem?**

```{r fog-sent}
styles |>
  ggplot(aes(fog_mean, sentiment_mean, color = source, label = club)) +
  geom_point(size = 3) +
  geom_text_repel(show.legend = FALSE, size = 3) +
  scale_color_manual(values = c(interpelacja = "#6c9ef0", stenogram = "#f05c5c")) +
  labs(
    x = "Średni FOG",
    y = "Średni sentyment",
    title = "Złożoność vs. wydźwięk",
    caption = "Brak wyraźnej korelacji: prostszy język nie zawsze oznacza ostrzejszy ton."
  )
```

## Tematy LDA

### Udział tematów w klubach (heatmapa)

```{r topic-heatmap}
topic_order <- topics_mix |>
  group_by(source, topic) |>
  summarise(mean_prop = mean(proportion), .groups = "drop") |>
  arrange(source, desc(mean_prop)) |>
  mutate(topic_ord = row_number())

topics_mix |>
  left_join(topic_lbl, by = c("source", "topic")) |>
  left_join(topic_order, by = c("source", "topic")) |>
  mutate(
    topic_lab = paste0(topic, ": ", str_trunc(label, 35)),
    topic_lab = fct_reorder(topic_lab, -topic_ord)
  ) |>
  ggplot(aes(topic_lab, club, fill = proportion)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "#f7fbff", high = "#08306b", labels = percent_format(accuracy = 1), limits = c(0, NA)) +
  facet_wrap(~source, ncol = 1) +
  labs(
    x = "Temat (LDA) – top 4 słów",
    y = NULL,
    fill = "Udział",
    title = "Profil tematyczny klubów – udział tematów LDA"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

### Słowa definiujące tematy

```{r topic-terms}
topics |>
  left_join(topic_lbl, by = c("source", "topic")) |>
  group_by(source, topic, label) |>
  slice_max(weight, n = 6) |>
  ungroup() |>
  mutate(term = reorder_within(term, weight, interaction(source, topic))) |>
  ggplot(aes(weight, term, fill = topic)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(source ~ label, scales = "free_y", ncol = 2) +
  scale_y_reordered() +
  labs(
    x = "Waga słowa w temacie",
    y = NULL,
    title = "Top słowa w tematach LDA (unigram + bigram)"
  )
```

## Rząd vs. opozycja – słownictwo dystynktywne

```{r log-odds}
log_plot <- function(src_label) {
  log_odds |>
    filter(source == src_label) |>
    group_by(group) |>
    slice_max(log_odds, n = 15) |>
    ungroup() |>
    mutate(term = fct_reorder(term, log_odds)) |>
    ggplot(aes(log_odds, term, fill = group)) +
    geom_col(show.legend = FALSE) +
    facet_wrap(~group, scales = "free_y") +
    labs(
      x = "Log-odds (różnica wobec drugiego bloku)",
      y = NULL,
      title = paste("Słowa odróżniające rząd i opozycję –", src_label)
    )
}

log_plot("interpelacja")
log_plot("stenogram")
```

## „Tusk” vs „Kaczyński”

```{r names}
name_long <- name_cnt |>
  select(club, source, tusk_per10k, kaczynski_per10k) |>
  pivot_longer(cols = c(tusk_per10k, kaczynski_per10k),
               names_to = "name", values_to = "per10k") |>
  mutate(
    source = recode(source, interpelacja = "Interpelacje", stenogram = "Stenogramy"),
    name = recode(name, tusk_per10k = "Tusk", kaczynski_per10k = "Kaczyński")
  )

ggplot(name_long, aes(per10k, fct_reorder(club, per10k), fill = name)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6) +
  facet_wrap(~source) +
  scale_fill_manual(values = c("Tusk" = "#FF7F2A", "Kaczyński" = "#012B7F")) +
  labs(
    x = "Wzmianki na 10 tys. słów",
    y = NULL,
    title = "Kto mówi częściej o Tusku, a kto o Kaczyńskim?"
  )
```

## Krótka interpretacja

- **Sentyment**: wszystkie kluby mówią na sali bardziej emocjonalnie niż piszą. Największy skok (ponad punkt) notuje *`r delta_top$club`*, co sugeruje ostrzejszą retorykę w debacie plenarnej.
- **Styl**: indeks FOG jest niższy w stenogramach (mniej urzędowego żargonu, krótsze zdania), zwłaszcza u *`r fog_gap$club`*.
- **Tematyka**: heatmapa pokazuje, że tematy 1–3 w stenogramach są mocniej „rozsmarowane” (większa dyspersja), podczas gdy interpelacje mają wyraźniejsze profile (np. tematy 4–6 przypisane do KO/PSL).
- **Słownictwo blokowe**: w interpelacjach opozycja eksponuje nazwiska i kwestie personalne, podczas gdy rządowe kluby częściej używają języka proceduralnego i administracyjnego; w stenogramach kontrast wzmacnia się o nazwiska i formy adresatywne.



[^konst460]: [Konstytucja Rzeczypospolitej Polskiej z dnia 2 kwietnia 1997 r. (Dz.U. 1997 nr 78 poz. 483), art. 96 ust. 1](https://www.sejm.gov.pl/prawo/konst/polski/4.htm#:~:text=Sejm%20składa%20się%20z%20460%20posłów)

[^konst4lata]: [Konstytucja Rzeczypospolitej Polskiej z dnia 2 kwietnia 1997 r. (Dz.U. 1997 nr 78 poz. 483), art. 98 ust. 1](https://www.sejm.gov.pl/prawo/konst/polski/4.htm#:~:text=Sejm%20i%20Senat%20są%20wybierane,zebrania%20się%20Sejmu%20następnej%20kadencji.) 

[^kodWybMandat]: [Ustawa z dnia 5 stycznia 2011 r. – Kodeks wyborczy (Dz.U. 2011 nr 21 poz. 112 z późn. zm.), art. 251 § 1–3](https://arslege.pl/obsadzenie-mandatu-posla-w-trakcie-kadencji-sejmu/k510/a43080/)

[^stronaSejmu]: [https://www.sejm.gov.pl/Sejm10.nsf/poslowie.xsp?type=A](https://www.sejm.gov.pl/Sejm10.nsf/poslowie.xsp?type=A)

[^geniusMata]: [https://genius.com/Mata-bede-prezydentem-lyrics](https://genius.com/Mata-bede-prezydentem-lyrics)

[^konst21Lat]: [Konstytucja Rzeczypospolitej Polskiej z dnia 2 kwietnia 1997 r. (Dz.U. 1997 nr 78 poz. 483), art. 99 ust. 1](https://www.sejm.gov.pl/prawo/konst/polski/4.htm)

[^mataWiek]: [https://pl.wikipedia.org/wiki/Mata_(raper)](https://pl.wikipedia.org/wiki/Mata_(raper))

[^konstPrezydentWiek]: [Konstytucja Rzeczypospolitej Polskiej z dnia 2 kwietnia 1997 r. (Dz.U. 1997 nr 78 poz. 483), art. 127 ust. 3](https://www.sejm.gov.pl/prawo/konst/polski/5.htm)
